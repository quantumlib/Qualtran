# How to build the docs

There are three stages of docs generation.

## Stages Overview

Stage 1 involves generating jupyter notebooks to document and demo each bloq.

 - This stage is configured in `autogenerate-bloqs-notebooks.py`. If you want to document
   a bloq, add it to the list in that file.
 - To run this stage, execute `autogenerate-bloqs-notebooks.py`.
 - The generated notebooks live *inside the source tree*, i.e. in (reporoot)/qualtran/bloqs/...
 - These notebooks should be committed to source control in a clean, un-executed form.
 - You can manually edit these notebooks with additional documentation or demonstrations.

Stage 2 involves executing and rendering doc content to the `docs/` folder.
Stage 2a consists of saving executed notebooks from the source tree to the `docs/` folder.
Stage 2b consists of extracting docstrings into the references sources in `docs/reference`.

 - The source of truth are the docstrings and notebooks committed in the source tree.
   Do not edit the autogenerated output files within the `docs/` folder.
 - These generated files should not be committed to `main` and are ignored via `docs/.gitignore`.
 - This stage requires a full, working installation of the library.

Stage 3 involves turning the complete sources in `docs/` into a website (html).

 - We use readthedocs to do this stage and host the docs. It's configured by `.readthedocs.yaml`.
 - You can build the html docs locally with `make html` from the `docs/` directory. The
   files are output to `docs/_build`.
 - This stage must not require a full installation of the library, since we want it to
   happen quickly and easily on readthedocs's servers.

## Stage 2

Whereas stage 1 is executed by contributors and committed to `main`; and whereas stage 3
is executed by readthedocs and hosted on the web; stage 2 is more tricky.

Roughly, the goal is to take a clean version of `main`, run the generation functionality
to output the content to `docs/` and either:
 1. commit the result somewhere so that readthedocs can find it.
 2. use sphinx to build the docs locally to preview them.

The two generation scripts are `execute-notebooks.py` and `build-reference-docs.py` in `dev_tools/`.

### Production: building and committing the stage 2 outputs.

We use the `docs` branch to commit the latest stage-2 outputs. This branch
has a different `docs/.gitignore` file so we can commit the stage-2 outputs.

    git switch docs 
    git fetch origin && git merge origin/main
    cat docs/.gitignore  # verify that outputs are un-ignored
    cd dev_tools/
    python clean-stage-2-doc-outputs.py  # delete all generated outputs
    python execute-notebooks.py --no-only-out-of-date
    python build-reference-docs.py
    cd ../docs
    git add .
    # .. verify the staged diff looks good ..
    git commit -m 'Generate docs'
    git push


### Local Preview: building and previewing the stage 2 outputs.

If you don't want to deploy the docs and just want to preview the html output locally,
you can stay on the `main` branch.

    cd docs/
    git clean -ndX  # delete all generated outputs: change -n to -f to actually do it.
    cd ../dev_tools/
    python execute-notebooks.py --no-only-out-of-date
    python build-reference-docs.py
    cd ../docs
    make clean && make html
